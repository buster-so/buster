name: Deploy Preview Environment

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches: [staging]
    
jobs:
  deploy-preview:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
    
    - name: Set Github variables
      id: vars
      run: |
        SHA_SHORT=$(git rev-parse --short=7 HEAD)
        echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
        
        # Get PR number from the workflow run
        PR_NUMBER=$(gh api repos/${{ github.repository }}/commits/${{ github.event.workflow_run.head_sha }}/pulls --jq '.[0].number' || echo "")
        echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        
        echo "ðŸ” SHA: ${SHA_SHORT}"
        echo "ðŸ” PR: ${PR_NUMBER}"
      env:
        GH_TOKEN: ${{ github.token }}
    
    - name: Setup porter
      uses: porter-dev/setup-porter@v0.1.0
    
    - name: Deploy API preview
      timeout-minutes: 30
      run: |
        # Create temporary porter.yaml with the Docker image
        cat > /tmp/porter-api.yaml <<EOF
        version: v2
        name: staging
        services:
        - name: api
          run: ""
          type: web
          image:
            repository: ghcr.io/buster-so/buster-api
            tag: preview-${{ steps.vars.outputs.sha_short }}
          instances: 1
          cpuCores: 1
          ramMegabytes: 2048
          port: 3001
        envGroups:
        - staging
        EOF
        
        exec porter apply -f /tmp/porter-api.yaml --preview
      env:
        PORTER_CLUSTER: 3155
        PORTER_HOST: https://dashboard.porter.run
        PORTER_PROJECT: 9309
        PORTER_APP_NAME: staging
        PORTER_TAG: preview-${{ steps.vars.outputs.sha_short }}
        PORTER_TOKEN: ${{ secrets.PORTER_APP_9309_3155 }}
        PORTER_PR_NUMBER: ${{ steps.vars.outputs.pr_number }}
        PORTER_REPO_NAME: ${{ github.event.repository.name }}
    
    - name: Deploy Server preview
      timeout-minutes: 30
      run: |
        # Create temporary porter.yaml with the Docker image
        cat > /tmp/porter-server.yaml <<EOF
        version: v2
        name: staging-server
        services:
        - name: server
          run: ""
          type: web
          image:
            repository: ghcr.io/buster-so/buster-server
            tag: preview-${{ steps.vars.outputs.sha_short }}
          instances: 1
          cpuCores: 2
          ramMegabytes: 5000
          port: 3002
        envGroups:
        - staging
        EOF
        
        exec porter apply -f /tmp/porter-server.yaml --preview
      env:
        PORTER_CLUSTER: 3155
        PORTER_HOST: https://dashboard.porter.run
        PORTER_PROJECT: 9309
        PORTER_APP_NAME: staging-server
        PORTER_TAG: preview-${{ steps.vars.outputs.sha_short }}
        PORTER_TOKEN: ${{ secrets.PORTER_APP_9309_3155 }}
        PORTER_PR_NUMBER: ${{ steps.vars.outputs.pr_number }}
        PORTER_REPO_NAME: ${{ github.event.repository.name }}
    
    - name: Deploy Electric server preview
      timeout-minutes: 30
      run: exec porter apply -f ./apps/electric-server/porter.yaml --preview
      env:
        PORTER_CLUSTER: 3155
        PORTER_HOST: https://dashboard.porter.run
        PORTER_PROJECT: 9309
        PORTER_APP_NAME: electric
        PORTER_TAG: ${{ steps.vars.outputs.sha_short }}
        PORTER_TOKEN: ${{ secrets.PORTER_APP_9309_3155 }}
        PORTER_PR_NUMBER: ${{ steps.vars.outputs.pr_number }}
        PORTER_REPO_NAME: ${{ github.event.repository.name }}
    
    - name: Output deployment URLs
      run: |
        echo "âœ… Preview environment deployed!"
        echo ""
        echo "ðŸ”— Deployment URLs will be available in Porter dashboard"
        echo "   PR #${{ steps.vars.outputs.pr_number }} - SHA: ${{ steps.vars.outputs.sha_short }}"